# form2list
form2list は階層構造のフォルダ内に格納されている申込書の Excel ファイルを巡回して、申請項目の内容を読み出し、指定された Excel ファイル内に一覧を書き出すプログラムです。
form2list は、変換の仕様を YAML ファイルから読み込み、一覧表の Excel に書き込みます。この YAML ファイルを変換仕様定義YAMLと呼びます。

## コマンドライン

form2list は以下の形式で起動することができます。

```
form2list [-c 変換仕様定義YAMLファイル名]　[-o 出力ファイル] 読み込みフォルダのパス
```

各オプションの意味は以下のとおりです。

|項目|意味|デフォルト|
|--|--|--|
|変換仕様定義YAMLファイル名|form2list の仕様を記載した YAML 形式のファイルです。相対パス、絶対パスのどちらも指定できます。|spec.yml|
|出力ファイル|form2list が書き込む Excel ファイルです。出力仕様に記載されたシートを持つ Excel ファイルが必要です。相対パス、絶対パスのどちらも指定できます。|list.xlsx|
|読み込みフォルダのパス|申込書が保存さいているフォルダのパスです。|必須です|

このコマンドは pytohn 3.12 以上がインストールされている環境でシェルから起動できます。プログラムはpythonで記述されており、1行目は以下のシェバングが書かれています。
```
#!/usr/bin/env python
```

## 変換仕様定義YAML

変換仕様定義YAMLでは、入力となる申込書Excel の解析方法、出力となる Excel への書き込み仕様を記述できます。この YAML ファイルの記述においては Jinja2 を使用して、動的な値を埋め込むことができます。まず、この変換仕様定義YAMLの例を示します。

```yaml
inputFormats:
  - items:
      # r6フォーマット
      申請種別ラベル: B12
      組織名: E14
      一般アカウントチェック: F16
      システムアカウントチェック: M16
      臨時アカウントチェック: T16
      アカウント管理者または部署名: E20
      アカウント管理者または部署のメールアドレス: E22
      システム名: E24
    condition: "{{ 申請種別ラベル == '申請種別' }}"
  - items:
      # 通常フォーマット
      組織名ラベル: B12
      組織名: E12
      一般アカウントチェック: F14
      システムアカウントチェック: L14
      臨時アカウントチェック: T14
      アカウント管理者または部署名: E18
      アカウント管理者または部署のメールアドレス: E20
      システム名: E22
    condition: "{{ 組織名ラベル == '組織名' }}"
sheets:
  - name: "申込書"
    columnOffset: 0
    rawOffset: 5
    columns:
      - name: ディレクトリ名
        value: "{{ dirname.split('/')[-1] }}"
      - name: ファイル名
        value: "{{ basename }}"
      - name: 組織名
        value: "{{ 組織名 }}"
      - name: 補正後組織名
        value: "{{ 組織名 | replace(' ', '') }}"
        conditionalFormat:
          rule:
            notEqual: "{{ RAW }}{{ COLUMN - 1 }}"
          format:
            color: 638EC6
      - name: アカウント種別
        value: "{{ '一般' if 一般アカウントチェック == '〇' else 'システム' if システムアカウントチェック == '〇' else '不明' }}"
      - name: アカウント管理者または部署名
        value: "{{ アカウント管理者または部署名 }}"
      - name: メールアドレス
        value: "{{ アカウント管理者または部署のメールアドレス }}"
      - name: 補正後メールアドレス
        value: "{{ アカウント管理者または部署のメールアドレス }}"
        conditionalFormat:
          rule:
            notEqual: "{{ RAW }}{{ COLUMN - 1 }}"
          format:
            color: 638EC6
      - name: システム名
        value: "{{ システム名 }}"      
  - name: "アカウントCSV"
    columnOffset: 0
    rawOffset: 5
    columns:
      - name: アクション
        value: Create
      - name: ID
        value: "=IF(申込書!{{ 申込書.columnNameOf.ディレクトリ名 }}{{ raw }}='一般アカウント','z','s')&XLOOKUP(申込書!{{  申込書.columnNameOf.ディレクトリ名 }}{{ raw }},ディレクトリ名!A:A,ディレクトリ名!B:B,'不明',0)&IF(XLOOKUP(申込書!{{  申込書.columnNameOf.ディレクトリ名 }}{{ raw }},ディレクトリ名!A:A,ディレクトリ名!B:B)='l',XLOOKUP(申込書!{{ 申込書.columnNameOf.補正後組織名 }}{{ raw }},所属コード!F:F,組織名!A:A),IF(XLOOKUP(申込書!{{ 申込書.columnNameOf.ディレクトリ名 }}{{ raw }},ディレクトリ名!A:A,ディレクトリ名!B:B)='c',XLOOKUP(申込書!{{ 申込書.columnNameOf.補正後組織名 }}{{ raw }},事業部!B:B,事業部!C:C),XLOOKUP(申込書!{{ 申込書.columnNameOf.補正後組織名 }}{{ raw }},会社コード!I:I,会社コード!H:H,'不明',0)))"
      - name: 表示名
        value: "=申込書!{{ 申込書.columnOf.補正後組織名 }}{{ raw }}"
      - name: アカウント種別
        value: "=申込書!{{ 申込書.columnOf.アカウント種別 }}{{ raw }}"
      - name: 等級
        value: "=XLOOKUP(申込書!{{ 申込書.columnOf.ディレクトリ名 }}{{ raw }},ディレクトリ名!A:A,ディレクトリ名!C:C,'不明',0)"
```

上記のように変換仕様定義YAMLのトップレベルは、入力ファイル解析仕様を表す inputFormats と出力ファイル内にどのようにデータを書き込むかを表す sheets からなります。
続く節でそれらについて説明します。

### 入力ファイル解析仕様(inputFormats)

inputFormats には入力ファイルフォーマットの配列を指定してください。
入力ファイルフォーマットは項目名からセルへのマッピングを表す items とフォーマットの適用条件を表す condition からなります。

#### items

items は項目名からセルへのマッピングを表す JSON オブジェクトです。
以降の処理で JSON　オブジェクトのキー名を Jinja2 の変数名、値をセルのアドレスとして入力 Excel ファイルの特定のセルの値を参照できます。

#### condition

condition では、その入力ファイルフォーマットを採用する条件を指定できます。
inputFormats のリストの中で最初に condition が True となるものを採用します。 
condition には Jinja2 テンプレートを指定することができ、その入力ファイルフォーマットの items で宣言された変数を参照することができます。
condition を省略した場合は、 True が指定されたものとみなされます。
condition の Jinja2 による評価結果が False となった場合は、inputFomats の次のフォーマットに移ります。このとき、 items のマッピングは一旦廃棄され、あたらしいフォーマットの items がロードされます。


### 出力仕様
form2list はコマンドラインで指定された読み込みフォルダの配下を再起的に巡回して、申込書のファイルを探します。ファイルの拡張子が xlsx でないものは無視されます。
申込書のExcel ファイルを開き、前節の解析結果を参照して sheets の出力定義に従って順次出力ファイルのシートに書き込みを行います。
sheets は出力定義のリストであり、一つの出力定義で出力ファイルの一つのシートに読み込んだ申込書に対応する行を追加します。
出力定義の項目は以下のとおりです。

|項目名|意味|必須/デフォルト値|
| -- | -- | -- |
|name|出力列の名前。シートのコンテキスト情報をこの名前の Jinja 変数に格納する。|必須|
|columns|出力列定義のリスト。リスト順に１行に書き込まれる。|必須|
|columnOffset |列のオフセット。 columns の最初の項目を何列目に配置するかを示し、0はA列に配置することを示す| 0 |
|rawOffset |行のオフセット。 最初の申込書を何行目に配置するかを示し、0は1行目に配置することを示す| 0 |

#### 出力列定義
出力列定義の項目は以下のとおりです。

|項目名|意味|必須/デフォルト値|
| -- | -- | -- |
|name|出力列の名前。Jinja2 のコンテキスト情報の中でこの名前のメンバの columnName メンバで列の名前(ex A,B,C ...）を参照できる。|必須|
|value |セルの値。"=" で始まる場合は、計算式を表す| 必須 |
|format |セルの表示形式| standard |

#### コンテキスト情報

出力列定義では、Jinja2の変数としてシートの名前でそのシートに書き込み中のコンテキスト情報を参照できる。コンテキスト情報には以下の情報がある。

|項目名|意味|
| -- | -- |
|rawNUmber|当該シートの中の現在の申込書の行番号|
|columnNameOf |出力項目名から書き込み列名へのマップオブジェクト|
